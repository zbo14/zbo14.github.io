---
layout: post
title: DIY VPN With WireGuard
---

I recently started working on a [project](/projects/diy-vpn/) to set up and run my own VPN using [OpenVPN](https://openvpn.net/) and [easy-rsa](https://github.com/OpenVPN/easy-rsa). Someone at work suggested I check out [WireGuard](https://www.wireguard.com/), a more modern and performant VPN that's open-source. Still under development at the time of writing, WireGuard is already supported by several major VPN providers. I decided to bootstrap my own WireGuard VPN and compare it with the OpenVPN solution.

If you'd like to learn more about WireGuard, check out the [whitepaper](https://www.wireguard.com/papers/wireguard.pdf) and documentation on the website. There are other resources that detail the technical differences between OpenVPN and WireGuard. The purpose of this post is to detail the procedural differences between the two if you want to set up your own VPN. Of course, the procedural differences stem from the technical differences so there's no escaping a little technical discussion ;)

A good place to start is authentication. A VPN server needs to be sure clients are who they say they are. Even if you're the only person using your VPN, you still might have multiple clients (e.g. your laptop and phone). Likewise, clients need to be sure the server is who it claims to be and not a malicious party masquerading as the VPN server. OpenVPN uses Transport Layer Security, or [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security), which provides authentication using digital certificates. When you visit an HTTPS site, your browser verifies the site's certificate, which was signed and issued by an entity called a Certificate Authority (CA). The (public) certificate asserts the site's ownership of a public key so we can trust signatures made by the corresponding (secret) private key (read up on [public-key/asymmetric cryptography](https://en.wikipedia.org/wiki/Public-key_cryptography), if you're unfamiliar). We assume the site's owners/administrators are the only ones in possession of the private key and, consequently, the only ones who can generate a valid signature using the private key. Therefore, if we receive a valid signature, we can be fairly certain the party we're talking to is the owner of the private key and, according to the trusted Certificate Authority, the rightful owner of the public key and domain.

When setting up an OpenVPN server, we need to create a Public Key Infrastructure (PKI). This includes a private key and self-signed certificate for our own trusted CA, a private key and CA-signed certificate for the VPN server, and a private key and CA-signed certificate for each client. In addition, we'll create a Certificate Revocation List (CRL) for keeping track of clients who have been removed/shouldn't be able to authenticate with the server any longer. While authentication with digital certificates makes sense for an open infrastructure like the web, it's a pretty heavy-handed approach for our personal VPN. The server host has to generate keys and certificates, which then have to be distributed to clients along with the CA certificate and most likely a config file. We can zip and encrypt a directory containing these files to ease distribution, but it's still kind of a pain to `sftp` the files to my laptop, unzip them, and iTunes sync them to my iPhone.

WireGuard does away with TLS, so no certificates required! Instead it uses [Cryptokey Routing](https://www.wireguard.com/#cryptokey-routing) to authenticate *peers* (i.e. clients and servers) and route packets. Each peer has a public/private key pair and a list of allowed IP addresses. When peer1 wants to send a packet to peer2, it encrypts the packet using peer2's public key - so that peer2 is the only party who can decrypt it, and sends it over the wire. Peer2 receives the packet, decrypts it, and checks the source IP. If the address falls in the range of allowed IPs for peer1, peer2 accepts the packet. Otherwise, the packet's dropped.

Suppose peer2 accepts a packet from peer1 and the destination IP address matches an allowed IP address for peer3. Peer2 then encrypts the packet using peer3's public key and sends it to peer3. The following quote from the [website documentation](https://www.wireguard.com/#cryptokey-routing) nicely summarizes this functionality:

> when sending packets, the list of allowed IPs behaves as a sort of routing table, and when receiving packets, the list of allowed IPs behaves as a sort of access control list.

The destination IP address doesn't have to be that of another peer. It could be an IP address for "reddit.com". If we're just using the VPN for web browsing, packets sent from the client to the server will be forwarded to "reddit.com" or wherever else we're browsing; not to another peer. The server still has to be certain a packet it receives is actually from the client who claims to have sent it. Thanks to public-key authentication and source IP checking (i.e. the "access control" list component mentioned above), WireGuard ensures a packet is actually coming from your laptop, phone, or another valid client.
